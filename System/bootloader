local function capsule()

print("Bootloading started...")

-- Store API's, frameworks, and data in here
_G["A"] = {}

A.version = "0.1a"

print("Running init...")

-- Run all init programs
for k,v in pairs(fs.list("/System/init")) do
	
	print("Loading "..v)
	
	local name = "/System/init/" .. v
	
	--Safety check
	if not fs.isDir(name) then
		os.run({["runTime"] = "boot"}, name)
	end
end

A.draw.write("Loaded init")

A.draw.reset()

A.draw.print("Loading frameworks")

for k,v in pairs(fs.list("/System/frameworks")) do
	
	A.draw.print("Loading "..v)
	
	local name = "/System/frameworks/" .. v
	
	--Safety check
	if not fs.isDir(name) then
		os.run({["runTime"] = "framework"}, name)
	end
end

A.draw.print("Loaded frameworks")

A.scratch:log("[Started]")

sleep(0.5)

A.scratch:log("Building GUI")

A.draw.clear()

local screen = A.gui.screen()

local pallet = A.gui.colorscheme()

local shutdown = A.gui.button(2, 2, 10, 1, "Shutdown", pallet, os.shutdown)

local reboot = A.gui.button(14, 2, 10, 1, "Reboot", pallet, os.reboot)

local text = A.gui.textbox(2, 6, 10, pallet)

screen:add(shutdown)
screen:add(reboot)
screen:add(text)

A.scratch:log("Starting GUI")

screen:listen(true)

A.scratch:log("[Shutdown]")

return false

end

-- Multi-error bug fix ;l

local handled = true

local function handleError(err)
	if handled then
		handled = false
	else
		return
	end
	if A.draw then
		local x, y = A.draw.getSize()
		A.draw.setColors(colors.white, colors.blue)
		for i = 1, y do
			A.draw.line(1, i, x, i)
			sleep(0.1)
		end
		A.draw.setCursorPos(5, 2)
		A.draw.write("Your system has crashed.")
		A.draw.setCursorPos(5, 4)
		A.draw.write("Error:")
		A.draw.setCursorPos(6, 5)
		A.draw.write(err, 6)
	else
		print("An error occurred while booting the system.")
		print("To maintain security, please repair or reinstall the system by booting of a disk.")
		print("Error: "..err)
	end
	if A.scratch then
		A.scratch:log("[Crash] " .. err)
	end
end

xpcall(capsule, handleError)

os.pullEvent("key")
os.shutdown()