local args = {...}
local base = args[1]
local oldPull = os.pullEvent
os.pullEvent = os.pullEventRaw
os.loadAPI(base .. "/System/sha")
os.loadAPI(base .. "/System/protect")
os.loadAPI(base .. "/System/file")
os.loadAPI(base .. "/System/updater")

_G.quartz = {}
_G.quartz.base = base

updater.run()

function sanitize(str)
	str = string.gsub(str, "/", ":")
	str = string.gsub(str, "%.", ":")
	return str
end

function login()
	print("Starting login...")
	term.setTextColor(colors.black)
	term.setBackgroundColor(colors.white)
	term.clear()
	term.setCursorPos(1, 1)
	local admins = textutils.unserialize(file.read(base .. "/System/admins"))
	print("Welcome to the Quartz login system.")
	print(string.rep("-", term.getSize()))
	write("Username:")
	local username = sanitize(read())
	if fs.exists(base .. "/Home/" .. username) then
		write("Password:")
		local password = sha.sha256(read("*"))
		if file.read(base .. "/Home/" .. username .. "/.passwd", nil) == password then
			term.clear()
			term.setCursorPos(1, 1)
			local admin = false
			for k, v in pairs(admins) do
				if v == username then
					admin = true
				end
			end
			if admin then
				protect.protect({"/"}, {"/"})
			else
				protect.protect({base .. "/Shared", base .. "/Home/" .. username, base .. "/tmp"}, {"/rom", base .. "/Shared", base .. "/Home/" .. username, base .. "/System/programs", base .. "/tmp"})
			end
			term.setBackgroundColor(colors.black)
			term.setTextColor(colors.white)
			term.clear()
			term.setCursorPos(1, 1)
			_G.quartz.user = username
			shell.setDir(base .. "/Home/" .. username)
			shell.setPath(shell.path() .. ":" .. base .. "/System/programs")
			shell.setAlias("nano", "edit")
			if admin then
				print("Welcome, admin.")
			end
			os.pullEvent = oldPull
			shell.run("shell")
		else
			print("Wrong password. Please try again")
			sleep(2)
			os.reboot()
		end
	else
		print("User not found. Please try again")
		sleep(2)
		os.reboot()
	end
end


if fs.exists(base .. "/System/.setupdone") then
	if fs.exists(base .. "/System/init") then
		parallel.waitForAny(login, function() 
			shell.run(base .. "/System/init")
		end)
		os.reboot()
	else
		login()
		os.reboot()
	end
else
	term.setTextColor(colors.black)
	term.setBackgroundColor(colors.white)
	term.clear()
	term.setCursorPos(1, 1)
	print("Welcome to the Quartz login system.")
	print(string.rep("-", term.getSize()))
	print("Please choose a username for the first account.")
	write("Username:")
	local username = sanitize(read())
	print("Please choose a password for the first account.")
	write("Password:")
	local password = sha.sha256(read("*"))
	term.clear()
	term.setCursorPos(1, 1)
	print("Please wait while we setup your account...")
	fs.makeDir(base .. "/Home/" .. username)
	file.write(base .. "/Home/" .. username .. "/.passwd", password)
	file.write(base .. "/System/admins", textutils.serialize({username}))
	file.write(base .. "/System/.setupdone", "YES")
	print("Done, please login with the username " .. username)
	sleep(1)
	os.reboot()
end
