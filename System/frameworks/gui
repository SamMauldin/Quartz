-- GUI Framework

-- Setup environment
A.gui = {}

A.gui.element = A.LCS.class({name = "element"})
A.gui.screen = A.LCS.class({name = "screen"})
A.gui.colorscheme = A.LCS.class({name = "colorscheme"})

function A.gui.screen:init(scheme)
	self.scheme = scheme or A.gui.colorscheme()
	self.gui = {}
end

function A.gui.screen:add(obj)
	table.insert(self.gui, obj)
end

function A.gui.screen:listen()
	while true do
		self.scheme:apply("screen")
		A.draw.clear()
		for k,v in pairs(self.gui) do
			v:draw()
		end
		local e = { os.pullEvent() }
		for k,v in pairs(self.gui) do
			v:event(e)
		end
	end
end

A.gui.app = A.gui.screen

-- Element framework
function A.gui.element:draw()

end

function A.gui.element:event()

end

-- Button class

A.gui.button = A.gui.element:extends()

function A.gui.button:init(x, y, w, h, text, scheme, handler)
	self.x = x
	self.y = y
	self.w = w
	self.h = h
	self.text = text
	self.scheme = scheme or A.gui.colorscheme()
	self.handler = handler
end

function A.gui.button:draw()
	self.scheme:apply("main")
	A.draw.box(self.x, self.y, self.x+self.w-1, self.y+self.h-1)
	local textLayerY = math.ceil(self.h/2)
	local textLayerX = math.ceil( ( self.w )/2 - #self.text/2 )
	A.draw.setCursorPos(self.x+textLayerX, self.y+textLayerY-1)
	A.draw.write(self.text)
end

function A.gui.button:event(ev)
	if ev[1] == "mouse_click" then
		if A.misc.contained(ev[3], ev[4], self.x, self.y, self.x+self.w-1, self.y+self.h-1) then
			self.handler(ev)
		end
	end
end

-- Textbox class

A.gui.textbox = A.gui.element:extends()

function A.gui.textbox:init(x, y, w, scheme, handler)
	self.x = x
	self.y = y
	self.w = w
	self.scheme = scheme or A.gui.colorscheme()
	self.handler = handler
	self.text = ""
	self.cursor = 0
	self.focused = false
end

function A.gui.textbox:draw()
	self.scheme:apply("main")
	if self.focused then
		self.scheme:apply("active")
	end

	A.draw.box(self.x, self.y, self.x + self.w, self.y)
	A.draw.setCursorPos(self.x, self.y)

	A.draw.write(self.text)

	if self.focused then
		A.draw.setCursorPos(self.x + self.cursor, self.y)
	end
end

function A.gui.textbox:getText()
	return self.text
end

function A.gui.textbox:event(ev)
	if self.focused then
		if ev[1] == "char" then
			self.cursor = self.cursor + 1
			self.text = self.text .. ev[2]
		elseif ev[1] == "key" then
			if ev[2] == keys.backspace or ev[2] == keys.delete then
				if self.cursor <= 0 then
					return
				end
				self.text = string.sub( self.text, 1, self.cursor - 1 ) .. string.sub( self.text, self.cursor +1 )
				self.cursor = self.cursor - 1
			end
			if ev[2] == keys.enter then
				self.focused = false
				if self.handler then
					self.handler()
				end
			end
		end
	end
	if ev[1] == "mouse_click" then
		if A.misc.contained(ev[3], ev[4], self.x, self.y, self.x + self.w, self.y + 1) then
			self.focused = true
		else
			self.focused = false
		end
	end
end

A.gui.password = A.gui.textbox:extends()

function A.gui.password:draw()
	self.scheme:apply("main")
	if self.focused then
		self.scheme:apply("active")
	end

	A.draw.box(self.x, self.y, self.x + self.w, self.y)
	A.draw.setCursorPos(self.x, self.y)

	A.draw.write(string.rep("*", string.len(self.text)))

	if self.focused then
		A.draw.setCursorPos(self.x + self.cursor, self.y)
	end
end

A.gui.label = A.gui.element:extends()

function A.gui.label:init(x, y, text, scheme)
	self.x = x
	self.y = y
	self.text = text
	self.scheme = scheme or A.gui.colorscheme()
end

function A.gui.label:draw()
	self.scheme:apply("text")
	A.draw.setCursorPos(self.x, self.y)
	A.draw.write(self.text)
end

A.gui.checkbox = A.gui.element:extends()

function A.gui.checkbox:init(x, y, handler, default, char, scheme)
	self.x = x
	self.y = y
	self.handler = handler
	self.text = char or {"Y", "N"}
	self.on = default or false
	self.scheme = scheme or A.gui.colorscheme()
end

function A.gui.checkbox:draw()
	self.scheme:apply("main")
	A.draw.setCursorPos(self.x, self.y)
	if self.on then
		A.draw.write(self.text[1])
	else
		A.draw.write(self.text[2])
	end
end

function A.gui.checkbox:event(ev)
	if ev[1] == "mouse_click" then
		if A.misc.contained(ev[3], ev[4], self.x, self.y, self.x + 1, self.y + 1) then
			self.on = not self.on
			if self.handler then
				self.handler(self.on)
			end
		end
	end
end

function A.gui.checkbox:getValue()
	return self.on
end

A.gui.panel = A.gui.element:extends()

function A.gui.panel:init(x, y, w, h, title, scheme)
	self.x = x
	self.y = y
	self.w = w
	self.h = h
	self.title = title
	self.scheme = scheme or A.gui.colorscheme()
end

function A.gui.panel:draw()
	self.scheme:apply("panel")
	A.draw.box(self.x, self.y, self.x + self.w-1, self.y+self.h-1)
	self.scheme:apply("bar")
	A.draw.box(self.x, self.y, self.x + self.w-1, self.y)
	A.draw.setCursorPos(self.x, self.y)
	A.draw.write(self.title)
end

--Color scheme

function A.gui.colorscheme:init()
	self.s = {}
	self.s.main = {colors.white, colors.lightGray}
	self.s.active = {colors.white, colors.lime}
	self.s.text = {colors.white, colors.lightBlue}
	self.s.highlight = {colors.lightBlue, colors.yellow}
	self.s.screen = {colors.white, colors.lightBlue}
	self.s.bar = {colors.white, colors.blue}
	self.s.panel = {colors.white, colors.gray}
end

function A.gui.colorscheme:set(scheme, value)
	self.s[scheme] = value
end

function A.gui.colorscheme:get(scheme)
	return self.s[scheme]
end

function A.gui.colorscheme:apply(scheme)
	A.draw.setColors(self.s[scheme][1], self.s[scheme][2])
end